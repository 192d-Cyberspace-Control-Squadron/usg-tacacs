# SPDX-License-Identifier: AGPL-3.0-only
# Patroni PostgreSQL HA cluster configuration
---
patroni_scope: "tacacs-policy-db"
patroni_postgresql_version: "16"

# etcd hosts for DCS
patroni_etcd_hosts:
  - host: "{{ hostvars['etcd1']['ansible_host'] | default('10.0.0.11') }}"
    port: 2379
  - host: "{{ hostvars['etcd2']['ansible_host'] | default('10.0.0.12') }}"
    port: 2379
  - host: "{{ hostvars['etcd3']['ansible_host'] | default('10.0.0.13') }}"
    port: 2379

# Authentication (use Ansible Vault in production)
patroni_superuser_password: "{{ vault_postgres_superuser_password }}"
patroni_replication_password: "{{ vault_postgres_replication_password }}"
patroni_restapi_password: "{{ vault_patroni_restapi_password }}"

# Application database for policy-ingest
patroni_app_database: tacacs_policy
patroni_app_username: tacacs_policy
patroni_app_password: "{{ vault_tacacs_policy_db_password }}"

# PostgreSQL tuning for policy-ingest workload
patroni_postgresql_parameters:
  # Connections
  max_connections: 200

  # Memory (adjust based on available RAM)
  shared_buffers: 256MB
  effective_cache_size: 768MB
  maintenance_work_mem: 128MB
  work_mem: 4MB

  # Checkpoints
  checkpoint_completion_target: 0.9
  wal_buffers: 16MB
  min_wal_size: 1GB
  max_wal_size: 4GB

  # Query planning
  default_statistics_target: 100
  random_page_cost: 1.1
  effective_io_concurrency: 200

  # Parallelism
  max_worker_processes: 4
  max_parallel_workers_per_gather: 2
  max_parallel_workers: 4

  # Replication
  wal_level: replica
  hot_standby: "on"
  max_wal_senders: 10
  max_replication_slots: 10
  hot_standby_feedback: "on"

  # Logging
  log_destination: stderr
  logging_collector: "on"
  log_directory: pg_log
  log_filename: postgresql-%Y-%m-%d.log
  log_min_duration_statement: 1000
  log_checkpoints: "on"
  log_connections: "on"
  log_disconnections: "on"

# Failover settings
patroni_bootstrap_dcs:
  ttl: 30
  loop_wait: 10
  retry_timeout: 10
  maximum_lag_on_failover: 1048576
  postgresql:
    use_pg_rewind: true
    use_slots: true
