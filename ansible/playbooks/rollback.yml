# SPDX-License-Identifier: AGPL-3.0-only
# Rollback TACACS+ server to previous version
---
- name: Rollback TACACS+ Server
  hosts: tacacs_servers
  become: true
  serial: 1
  gather_facts: true

  vars:
    rollback_binary_url: ""  # Must be provided
    rollback_binary_checksum: ""  # Must be provided
    rollback_health_retries: 10
    rollback_health_delay: 3

  pre_tasks:
    - name: Validate rollback variables
      ansible.builtin.assert:
        that:
          - rollback_binary_url | length > 0
          - rollback_binary_checksum | length > 0
        fail_msg: "rollback_binary_url and rollback_binary_checksum must be provided"

    - name: Check current version
      ansible.builtin.command:
        cmd: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server --version"
      register: current_version
      changed_when: false
      failed_when: false

    - name: Display current version
      ansible.builtin.debug:
        msg: "Current version before rollback: {{ current_version.stdout | default('unknown') }}"

  tasks:
    - name: Stop tacacs-server
      ansible.builtin.systemd:
        name: tacacs-server
        state: stopped

    - name: Backup current binary
      ansible.builtin.copy:
        src: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server"
        dest: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server.failed"
        remote_src: true
        mode: preserve

    - name: Download rollback binary
      ansible.builtin.get_url:
        url: "{{ rollback_binary_url }}"
        dest: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server"
        checksum: "sha256:{{ rollback_binary_checksum }}"
        owner: root
        group: root
        mode: "0755"
        force: true

    - name: Start tacacs-server
      ansible.builtin.systemd:
        name: tacacs-server
        state: started

    - name: Verify health endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_http_port | default(8080) }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: "{{ rollback_health_retries }}"
      delay: "{{ rollback_health_delay }}"
      until: health_check.status == 200

  post_tasks:
    - name: Check new version
      ansible.builtin.command:
        cmd: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server --version"
      register: new_version
      changed_when: false

    - name: Display rollback status
      ansible.builtin.debug:
        msg: "Rolled back from {{ current_version.stdout | default('unknown') }} to {{ new_version.stdout }}"

    - name: Remove failed binary backup
      ansible.builtin.file:
        path: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server.failed"
        state: absent
