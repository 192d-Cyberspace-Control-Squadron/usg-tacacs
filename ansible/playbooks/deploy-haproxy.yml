# SPDX-License-Identifier: Apache-2.0
# Deploy HAProxy load balancer for TACACS+ high availability
---
- name: Deploy HAProxy for TACACS+ HA
  hosts: haproxy
  become: true
  gather_facts: true

  vars_files:
    - ../inventory/production/group_vars/haproxy.yml

  pre_tasks:
    - name: Verify TACACS+ backends are reachable
      ansible.builtin.uri:
        url: "http://{{ item.address }}:{{ item.http_port | default(8080) }}/ready"
        status_code: 200
        timeout: 5
      loop: "{{ tacacs_ha_backends }}"
      register: backend_health
      ignore_errors: true

    - name: Warn about unhealthy backends
      ansible.builtin.debug:
        msg: "WARNING: Backend {{ item.item.name }} ({{ item.item.address }}) is not responding to health checks"
      loop: "{{ backend_health.results }}"
      when: item.failed | default(false)

  roles:
    - role: tacacs_ha

  post_tasks:
    - name: Verify HAProxy is serving traffic
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_ha_stats_port }}/stats"
        status_code: 200
        url_username: "{{ tacacs_ha_stats_user }}"
        url_password: "{{ tacacs_ha_stats_password }}"
        force_basic_auth: true

    - name: Display HAProxy stats URL
      ansible.builtin.debug:
        msg: "HAProxy stats available at http://{{ ansible_host }}:{{ tacacs_ha_stats_port }}/stats"

    - name: Test TACACS+ legacy port connectivity
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ tacacs_ha_legacy_port }}"
        timeout: 10

    - name: Test TACACS+ TLS port connectivity
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ tacacs_ha_tls_port }}"
        timeout: 10
