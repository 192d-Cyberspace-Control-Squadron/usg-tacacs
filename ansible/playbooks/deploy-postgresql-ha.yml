# SPDX-License-Identifier: AGPL-3.0-only
# Deploy PostgreSQL HA cluster for policy-ingest service
# Order: etcd cluster -> Patroni cluster -> PgBouncer
---
- name: Deploy etcd cluster for Patroni DCS
  hosts: etcd
  become: true
  gather_facts: true
  serial: 1  # Deploy one node at a time for safe cluster formation

  vars_files:
    - ../inventory/production/group_vars/etcd.yml

  roles:
    - role: etcd

  post_tasks:
    - name: Verify etcd cluster health
      ansible.builtin.command:
        cmd: /usr/local/bin/etcdctl endpoint health --cluster --endpoints=http://127.0.0.1:2379
      register: etcd_cluster_health
      changed_when: false
      run_once: true
      delegate_to: "{{ groups['etcd'][0] }}"

    - name: Display etcd cluster status
      ansible.builtin.debug:
        msg: "{{ etcd_cluster_health.stdout_lines }}"
      run_once: true

- name: Deploy Patroni PostgreSQL HA cluster
  hosts: patroni
  become: true
  gather_facts: true
  serial: 1  # Deploy one node at a time for safe cluster initialization

  vars_files:
    - ../inventory/production/group_vars/patroni.yml

  pre_tasks:
    - name: Verify etcd is accessible
      ansible.builtin.uri:
        url: "http://{{ patroni_etcd_hosts[0].host }}:{{ patroni_etcd_hosts[0].port }}/health"
        status_code: 200
      register: etcd_check
      retries: 5
      delay: 3
      until: etcd_check.status == 200

  roles:
    - role: patroni

  post_tasks:
    - name: Check Patroni cluster status
      ansible.builtin.uri:
        url: "http://127.0.0.1:8008/cluster"
        return_content: true
      register: patroni_cluster
      run_once: true
      delegate_to: "{{ groups['patroni'][0] }}"

    - name: Display Patroni cluster status
      ansible.builtin.debug:
        msg: "Patroni cluster: {{ patroni_cluster.json }}"
      run_once: true

- name: Deploy PgBouncer connection pooler
  hosts: pgbouncer
  become: true
  gather_facts: true

  vars_files:
    - ../inventory/production/group_vars/pgbouncer.yml

  pre_tasks:
    - name: Get Patroni leader
      ansible.builtin.uri:
        url: "http://{{ patroni_leader_host | default(groups['patroni'][0]) }}:8008/leader"
        status_code: [200, 503]
      register: patroni_leader_check
      ignore_errors: true

  roles:
    - role: pgbouncer

  post_tasks:
    - name: Verify PgBouncer is accepting connections
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ pgbouncer_listen_port }}"
        timeout: 30

    - name: Display connection info
      ansible.builtin.debug:
        msg: |
          PostgreSQL HA cluster deployed successfully!

          Connect via PgBouncer: psql -h {{ ansible_host }} -p {{ pgbouncer_listen_port }} -U {{ patroni_app_username }} {{ patroni_app_database }}

          Patroni REST API: http://{{ groups['patroni'][0] }}:8008/
          etcd endpoints: {% for host in patroni_etcd_hosts %}http://{{ host.host }}:{{ host.port }}{% if not loop.last %}, {% endif %}{% endfor %}
