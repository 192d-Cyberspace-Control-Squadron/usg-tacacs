# SPDX-License-Identifier: AGPL-3.0-only
# Upgrade TACACS+ server with graceful restart
---
- name: Upgrade TACACS+ Server
  hosts: tacacs_servers
  become: true
  serial: 1  # Rolling upgrade, one server at a time
  gather_facts: true

  vars:
    upgrade_drain_timeout: 30
    upgrade_health_retries: 10
    upgrade_health_delay: 3

  pre_tasks:
    - name: Check current version
      ansible.builtin.command:
        cmd: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server --version"
      register: current_version
      changed_when: false
      failed_when: false

    - name: Display current version
      ansible.builtin.debug:
        msg: "Current version: {{ current_version.stdout | default('unknown') }}"

    - name: Initiate graceful drain (set not ready)
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_http_port | default(8080) }}/ready"
        method: GET
        status_code: [200, 503]
      register: ready_check

    - name: Wait for active connections to drain
      ansible.builtin.pause:
        seconds: "{{ upgrade_drain_timeout }}"
      when: ready_check.status == 200

  roles:
    - role: tacacs_server

  post_tasks:
    - name: Verify new version is running
      ansible.builtin.command:
        cmd: "{{ tacacs_bin_dir | default('/usr/local/bin') }}/tacacs-server --version"
      register: new_version
      changed_when: false

    - name: Verify health endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_http_port | default(8080) }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: "{{ upgrade_health_retries }}"
      delay: "{{ upgrade_health_delay }}"
      until: health_check.status == 200

    - name: Verify ready endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_http_port | default(8080) }}/ready"
        method: GET
        status_code: 200
      register: ready_check
      retries: "{{ upgrade_health_retries }}"
      delay: "{{ upgrade_health_delay }}"
      until: ready_check.status == 200

    - name: Display upgrade status
      ansible.builtin.debug:
        msg: "Upgraded from {{ current_version.stdout | default('unknown') }} to {{ new_version.stdout }}"
