# SPDX-License-Identifier: Apache-2.0
# Deploy BGP Anycast for TACACS+ geographic distribution
---
- name: Deploy BGP Anycast for TACACS+ servers
  hosts: tacacs_anycast
  become: true
  gather_facts: true
  serial: "{{ anycast_deploy_batch | default(10) }}"  # Deploy in batches

  vars_files:
    - ../inventory/production/group_vars/frr_anycast.yml

  pre_tasks:
    - name: Verify TACACS+ server is running
      ansible.builtin.uri:
        url: "http://127.0.0.1:8080/health"
        status_code: 200
        timeout: 5
      register: tacacs_health
      ignore_errors: true

    - name: Warn if TACACS+ is not healthy
      ansible.builtin.debug:
        msg: "WARNING: TACACS+ server is not responding to health checks on {{ inventory_hostname }}"
      when: tacacs_health.failed | default(false)

  roles:
    - role: frr_anycast

  post_tasks:
    - name: Wait for BGP session to establish
      ansible.builtin.pause:
        seconds: 10

    - name: Check BGP neighbor status
      ansible.builtin.command:
        cmd: vtysh -c "show bgp summary json"
      register: bgp_status
      changed_when: false

    - name: Parse BGP status
      ansible.builtin.set_fact:
        bgp_json: "{{ bgp_status.stdout | from_json }}"
      ignore_errors: true

    - name: Display BGP neighbor status
      ansible.builtin.debug:
        msg: |
          BGP Status for {{ inventory_hostname }}:
          - Router ID: {{ bgp_json.routerId | default('unknown') }}
          - AS: {{ bgp_json.as | default('unknown') }}
          - Peers: {{ bgp_json.peerCount | default(0) }}
      when: bgp_json is defined

    - name: Verify anycast route is advertised
      ansible.builtin.command:
        cmd: vtysh -c "show ip bgp {{ frr_anycast_vip }}/{{ frr_anycast_vip_prefix }}"
      register: route_check
      changed_when: false
      ignore_errors: true

    - name: Display route status
      ansible.builtin.debug:
        msg: "{{ route_check.stdout_lines }}"
      when: route_check.rc == 0

- name: Validate anycast from core router perspective
  hosts: localhost
  gather_facts: false
  run_once: true

  tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          BGP Anycast Deployment Complete!

          Anycast VIP: {{ frr_anycast_vip | default('10.255.255.1') }}
          Locations deployed: {{ groups['tacacs_anycast'] | length }}

          To verify from a network device:
            show ip route {{ frr_anycast_vip | default('10.255.255.1') }}
            show ip bgp {{ frr_anycast_vip | default('10.255.255.1') }}

          The anycast VIP should now be reachable from any location,
          with traffic routed to the nearest healthy TACACS+ server.
