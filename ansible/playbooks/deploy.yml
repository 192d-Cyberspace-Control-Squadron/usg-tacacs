# SPDX-License-Identifier: AGPL-3.0-only
# Deploy TACACS+ server to target hosts
---
- name: Deploy TACACS+ Server
  hosts: tacacs_servers
  become: true
  gather_facts: true

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - tacacs_shared_secret is defined
          - tacacs_shared_secret != "CHANGE_ME_IN_PRODUCTION"
        fail_msg: "tacacs_shared_secret must be set and not the default value"
        success_msg: "Required variables validated"

  roles:
    - role: tacacs_server

  post_tasks:
    - name: Verify TACACS+ server is responding
      ansible.builtin.uri:
        url: "http://{{ tacacs_http_address | default('127.0.0.1') }}:{{ tacacs_http_port | default(8080) }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 5
      delay: 2
      until: health_check.status == 200

    - name: Display deployment status
      ansible.builtin.debug:
        msg: "TACACS+ server deployed successfully at {{ inventory_hostname }}"
