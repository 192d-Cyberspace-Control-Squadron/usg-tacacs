# SPDX-License-Identifier: AGPL-3.0-only
# Rotate TLS certificates for TACACS+ server
---
- name: Rotate TLS Certificates
  hosts: tacacs_servers
  become: true
  serial: 1
  gather_facts: true

  vars:
    cert_src_dir: ""  # Local directory with new certs
    cert_backup_enabled: true

  pre_tasks:
    - name: Validate certificate source
      ansible.builtin.assert:
        that:
          - cert_src_dir | length > 0
        fail_msg: "cert_src_dir must be provided"

    - name: Check if new certificate exists
      ansible.builtin.stat:
        path: "{{ cert_src_dir }}/server.crt"
      delegate_to: localhost
      become: false
      register: new_cert

    - name: Fail if certificate not found
      ansible.builtin.fail:
        msg: "New certificate not found at {{ cert_src_dir }}/server.crt"
      when: not new_cert.stat.exists

  tasks:
    - name: Backup current certificates
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ item }}.backup.{{ ansible_date_time.iso8601_basic_short }}"
        remote_src: true
        mode: preserve
      loop:
        - "{{ tacacs_tls_cert_file | default('/etc/tacacs/certs/server.crt') }}"
        - "{{ tacacs_tls_key_file | default('/etc/tacacs/certs/server.key') }}"
      when: cert_backup_enabled | bool

    - name: Deploy new certificate
      ansible.builtin.copy:
        src: "{{ cert_src_dir }}/server.crt"
        dest: "{{ tacacs_tls_cert_file | default('/etc/tacacs/certs/server.crt') }}"
        owner: "{{ tacacs_user | default('tacacs') }}"
        group: "{{ tacacs_group | default('tacacs') }}"
        mode: "0644"

    - name: Deploy new private key
      ansible.builtin.copy:
        src: "{{ cert_src_dir }}/server.key"
        dest: "{{ tacacs_tls_key_file | default('/etc/tacacs/certs/server.key') }}"
        owner: "{{ tacacs_user | default('tacacs') }}"
        group: "{{ tacacs_group | default('tacacs') }}"
        mode: "0600"

    - name: Deploy new CA certificate (if provided)
      ansible.builtin.copy:
        src: "{{ cert_src_dir }}/ca.crt"
        dest: "{{ tacacs_tls_ca_file | default('/etc/tacacs/certs/ca.crt') }}"
        owner: "{{ tacacs_user | default('tacacs') }}"
        group: "{{ tacacs_group | default('tacacs') }}"
        mode: "0644"
      when: lookup('file', cert_src_dir + '/ca.crt', errors='ignore') | length > 0

    - name: Reload tacacs-server to pick up new certificates
      ansible.builtin.systemd:
        name: tacacs-server
        state: reloaded

    - name: Wait for server to be ready
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ tacacs_http_port | default(8080) }}/ready"
        method: GET
        status_code: 200
      register: ready_check
      retries: 5
      delay: 2
      until: ready_check.status == 200

  post_tasks:
    - name: Display certificate rotation status
      ansible.builtin.debug:
        msg: "Certificate rotation completed for {{ inventory_hostname }}"
