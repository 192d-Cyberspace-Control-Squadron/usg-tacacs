---
# AppRole setup for TACACS+ server authentication to OpenBao

- name: Create AppRole for TACACS server
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/auth/approle/role/{{ openbao_approle_role_name }}"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      token_policies: "{{ openbao_approle_policies }}"
      token_ttl: "1h"
      token_max_ttl: "4h"
      secret_id_ttl: "0"  # Non-expiring for service accounts
      secret_id_num_uses: 0
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204]
  delegate_to: localhost
  run_once: true

- name: Get role_id for AppRole
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/auth/approle/role/{{ openbao_approle_role_name }}/role-id"
    method: GET
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
  register: role_id_response
  delegate_to: localhost
  run_once: true

- name: Generate secret_id for this host
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/auth/approle/role/{{ openbao_approle_role_name }}/secret-id"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      metadata: "host={{ inventory_hostname }}"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
  register: secret_id_response
  delegate_to: localhost

- name: Ensure TACACS config directory exists
  ansible.builtin.file:
    path: /etc/tacacs
    state: directory
    owner: root
    group: "{{ tacacs_group }}"
    mode: "0750"

- name: Deploy role_id file
  ansible.builtin.copy:
    content: "{{ role_id_response.json.data.role_id }}"
    dest: "{{ openbao_role_id_file }}"
    owner: root
    group: "{{ tacacs_group }}"
    mode: "0640"
  notify: Restart TACACS server

- name: Deploy secret_id file
  ansible.builtin.copy:
    content: "{{ secret_id_response.json.data.secret_id }}"
    dest: "{{ openbao_secret_id_file }}"
    owner: root
    group: "{{ tacacs_group }}"
    mode: "0600"
  no_log: true
  notify: Restart TACACS server
