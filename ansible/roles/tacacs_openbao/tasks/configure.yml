---
# Configure OpenBao secrets policy and mount points

- name: Create TACACS secrets policy
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/sys/policies/acl/tacacs-secrets"
    method: PUT
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      policy: "{{ lookup('template', 'tacacs-policy.hcl.j2') }}"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204]
  delegate_to: localhost
  run_once: true
  when: openbao_root_token is defined

- name: Enable KV v2 secrets engine if not already enabled
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/sys/mounts/secret"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      type: "kv"
      options:
        version: "2"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204, 400]  # 400 if already enabled
  delegate_to: localhost
  run_once: true
  when: openbao_root_token is defined
  register: kv_enable_result
  failed_when: >
    kv_enable_result.status not in [200, 204] and
    'path is already in use' not in (kv_enable_result.json.errors | default(['']) | join(''))

- name: Enable AppRole auth method if not already enabled
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/sys/auth/approle"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      type: "approle"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204, 400]  # 400 if already enabled
  delegate_to: localhost
  run_once: true
  when: openbao_root_token is defined
  register: approle_enable_result
  failed_when: >
    approle_enable_result.status not in [200, 204] and
    'path is already in use' not in (approle_enable_result.json.errors | default(['']) | join(''))
