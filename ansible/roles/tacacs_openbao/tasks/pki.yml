---
# PKI secrets engine setup for automatic TLS certificate management

- name: Enable PKI secrets engine if not already enabled
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/sys/mounts/{{ openbao_pki_mount }}"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      type: "pki"
      config:
        max_lease_ttl: "87600h"  # 10 years
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204, 400]
  delegate_to: localhost
  run_once: true
  register: pki_enable_result
  failed_when: >
    pki_enable_result.status not in [200, 204] and
    'path is already in use' not in (pki_enable_result.json.errors | default(['']) | join(''))

- name: Generate root CA if not already present
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/{{ openbao_pki_mount }}/root/generate/internal"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      common_name: "TACACS Root CA"
      ttl: "87600h"
      key_type: "ec"
      key_bits: 384
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204, 400]
  delegate_to: localhost
  run_once: true
  register: root_ca_result
  failed_when: >
    root_ca_result.status not in [200, 204] and
    'keys already exist' not in (root_ca_result.json.errors | default(['']) | join(''))

- name: Configure PKI URLs
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/{{ openbao_pki_mount }}/config/urls"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      issuing_certificates: "{{ openbao_address }}/v1/{{ openbao_pki_mount }}/ca"
      crl_distribution_points: "{{ openbao_address }}/v1/{{ openbao_pki_mount }}/crl"
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204]
  delegate_to: localhost
  run_once: true

- name: Create PKI role for TACACS server certificates
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/{{ openbao_pki_mount }}/roles/{{ openbao_pki_role }}"
    method: POST
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      allowed_domains: "{{ openbao_pki_allowed_domains }}"
      allow_subdomains: true
      allow_bare_domains: true
      max_ttl: "{{ openbao_pki_ttl }}"
      key_type: "ec"
      key_bits: 256
      require_cn: true
      server_flag: true
      client_flag: false
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204]
  delegate_to: localhost
  run_once: true

- name: Add PKI policy to tacacs-pki
  ansible.builtin.uri:
    url: "{{ openbao_address }}/v1/sys/policies/acl/tacacs-pki"
    method: PUT
    headers:
      X-Vault-Token: "{{ openbao_root_token }}"
    body_format: json
    body:
      policy: |
        # Allow TACACS servers to issue certificates
        path "{{ openbao_pki_mount }}/issue/{{ openbao_pki_role }}" {
          capabilities = ["create", "update"]
        }

        # Allow reading the CA certificate
        path "{{ openbao_pki_mount }}/cert/ca" {
          capabilities = ["read"]
        }
    validate_certs: "{{ openbao_ca_file | length > 0 }}"
    status_code: [200, 204]
  delegate_to: localhost
  run_once: true
