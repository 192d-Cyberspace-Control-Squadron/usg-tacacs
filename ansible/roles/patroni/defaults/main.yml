# SPDX-License-Identifier: Apache-2.0
# patroni - Default variables for Patroni PostgreSQL HA
---
# PostgreSQL version
patroni_postgresql_version: "16"

# Patroni configuration
patroni_scope: "tacacs-policy-db"
patroni_namespace: "/service/"
patroni_name: "{{ inventory_hostname }}"

# DCS (Distributed Configuration Store)
patroni_dcs_type: etcd3
patroni_etcd_hosts: []
# Example:
# patroni_etcd_hosts:
#   - host: 10.0.0.11
#     port: 2379
#   - host: 10.0.0.12
#     port: 2379
#   - host: 10.0.0.13
#     port: 2379

# PostgreSQL configuration
patroni_postgresql_data_dir: "/var/lib/postgresql/{{ patroni_postgresql_version }}/data"
patroni_postgresql_bin_dir: "/usr/lib/postgresql/{{ patroni_postgresql_version }}/bin"
patroni_postgresql_config_dir: "/etc/postgresql/{{ patroni_postgresql_version }}"
patroni_postgresql_port: 5432
patroni_postgresql_listen: "0.0.0.0"

# Patroni REST API
patroni_restapi_listen: "0.0.0.0:8008"
patroni_restapi_connect_address: "{{ ansible_host }}:8008"
patroni_restapi_username: patroni
patroni_restapi_password: "CHANGE_ME"

# PostgreSQL authentication
patroni_superuser_username: postgres
patroni_superuser_password: "CHANGE_ME"
patroni_replication_username: replicator
patroni_replication_password: "CHANGE_ME"

# Application database (for policy-ingest)
patroni_app_database: tacacs_policy
patroni_app_username: tacacs_policy
patroni_app_password: "CHANGE_ME"

# PostgreSQL parameters
patroni_postgresql_parameters:
  max_connections: 200
  shared_buffers: 256MB
  effective_cache_size: 768MB
  maintenance_work_mem: 128MB
  checkpoint_completion_target: 0.9
  wal_buffers: 16MB
  default_statistics_target: 100
  random_page_cost: 1.1
  effective_io_concurrency: 200
  min_wal_size: 1GB
  max_wal_size: 4GB
  max_worker_processes: 4
  max_parallel_workers_per_gather: 2
  max_parallel_workers: 4
  max_parallel_maintenance_workers: 2
  wal_level: replica
  hot_standby: "on"
  max_wal_senders: 10
  max_replication_slots: 10
  hot_standby_feedback: "on"
  log_destination: stderr
  logging_collector: "on"
  log_directory: pg_log
  log_filename: postgresql-%Y-%m-%d.log
  log_rotation_age: 1d
  log_rotation_size: 100MB
  log_min_duration_statement: 1000
  log_checkpoints: "on"
  log_connections: "on"
  log_disconnections: "on"
  log_lock_waits: "on"

# Patroni bootstrap configuration
patroni_bootstrap_dcs:
  ttl: 30
  loop_wait: 10
  retry_timeout: 10
  maximum_lag_on_failover: 1048576  # 1MB
  postgresql:
    use_pg_rewind: true
    use_slots: true

# Watchdog (optional, for fencing)
patroni_watchdog_mode: "off"  # off, automatic, required
patroni_watchdog_device: /dev/watchdog

# Tags
patroni_tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false

# User/group
patroni_user: postgres
patroni_group: postgres

# Firewall
patroni_configure_firewall: true
