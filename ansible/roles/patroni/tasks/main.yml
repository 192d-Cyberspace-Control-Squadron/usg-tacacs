# SPDX-License-Identifier: Apache-2.0
# patroni - Main tasks for Patroni PostgreSQL HA deployment
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - patroni_etcd_hosts | length >= 3
      - patroni_superuser_password != "CHANGE_ME"
      - patroni_replication_password != "CHANGE_ME"
      - patroni_restapi_password != "CHANGE_ME"
      - patroni_app_password != "CHANGE_ME"
    fail_msg: "Required variables not set. Check etcd_hosts and passwords."

- name: Install PostgreSQL repository (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Add PostgreSQL APT key
      ansible.builtin.apt_key:
        url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
        state: present

    - name: Add PostgreSQL repository
      ansible.builtin.apt_repository:
        repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
        state: present

- name: Install PostgreSQL repository (RHEL)
  when: ansible_os_family == "RedHat"
  block:
    - name: Install PostgreSQL repository RPM
      ansible.builtin.dnf:
        name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ ansible_distribution_major_version }}-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
        state: present
        disable_gpg_check: true

    - name: Disable built-in PostgreSQL module
      ansible.builtin.command:
        cmd: dnf module disable postgresql -y
      changed_when: false
      ignore_errors: true

- name: Install PostgreSQL and dependencies
  ansible.builtin.package:
    name:
      - "postgresql-{{ patroni_postgresql_version }}"
      - "postgresql-{{ patroni_postgresql_version }}-contrib"
      - python3-pip
      - python3-psycopg2
    state: present

- name: Install Patroni via pip
  ansible.builtin.pip:
    name:
      - patroni[etcd3]
      - python-etcd
    state: present

- name: Create Patroni configuration directory
  ansible.builtin.file:
    path: /etc/patroni
    state: directory
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    mode: "0750"

- name: Create PostgreSQL data directory
  ansible.builtin.file:
    path: "{{ patroni_postgresql_data_dir }}"
    state: directory
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    mode: "0700"

- name: Deploy Patroni configuration
  ansible.builtin.template:
    src: patroni.yml.j2
    dest: /etc/patroni/patroni.yml
    owner: "{{ patroni_user }}"
    group: "{{ patroni_group }}"
    mode: "0600"
  notify: Reload patroni

- name: Deploy Patroni systemd service
  ansible.builtin.template:
    src: patroni.service.j2
    dest: /etc/systemd/system/patroni.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart patroni

- name: Configure firewall for PostgreSQL (firewalld)
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - "{{ patroni_postgresql_port }}"
    - "8008"  # Patroni REST API
  when:
    - patroni_configure_firewall | bool
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: Configure firewall for PostgreSQL (ufw)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "{{ patroni_postgresql_port }}"
    - "8008"
  when:
    - patroni_configure_firewall | bool
    - ansible_os_family == "Debian"
  ignore_errors: true

- name: Enable and start Patroni
  ansible.builtin.systemd:
    name: patroni
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for Patroni to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:8008/health"
    status_code: 200
  register: patroni_health
  retries: 30
  delay: 5
  until: patroni_health.status == 200

- name: Create application database and user (only on leader)
  when: inventory_hostname == groups['patroni'][0]
  block:
    - name: Wait for cluster to be initialized
      ansible.builtin.pause:
        seconds: 10

    - name: Check if we are the leader
      ansible.builtin.uri:
        url: "http://127.0.0.1:8008/leader"
        status_code: [200, 503]
      register: leader_check

    - name: Create application database
      community.postgresql.postgresql_db:
        name: "{{ patroni_app_database }}"
        state: present
        login_user: "{{ patroni_superuser_username }}"
        login_password: "{{ patroni_superuser_password }}"
        login_host: 127.0.0.1
        port: "{{ patroni_postgresql_port }}"
      when: leader_check.status == 200

    - name: Create application user
      community.postgresql.postgresql_user:
        name: "{{ patroni_app_username }}"
        password: "{{ patroni_app_password }}"
        db: "{{ patroni_app_database }}"
        priv: "ALL"
        state: present
        login_user: "{{ patroni_superuser_username }}"
        login_password: "{{ patroni_superuser_password }}"
        login_host: 127.0.0.1
        port: "{{ patroni_postgresql_port }}"
      when: leader_check.status == 200
