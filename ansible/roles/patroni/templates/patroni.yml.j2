# SPDX-License-Identifier: AGPL-3.0-only
# Patroni configuration for PostgreSQL HA
# Managed by Ansible - do not edit manually

scope: {{ patroni_scope }}
namespace: {{ patroni_namespace }}
name: {{ patroni_name }}

restapi:
  listen: {{ patroni_restapi_listen }}
  connect_address: {{ patroni_restapi_connect_address }}
  authentication:
    username: {{ patroni_restapi_username }}
    password: {{ patroni_restapi_password }}

etcd3:
  hosts:
{% for host in patroni_etcd_hosts %}
    - {{ host.host }}:{{ host.port | default(2379) }}
{% endfor %}

bootstrap:
  dcs:
    ttl: {{ patroni_bootstrap_dcs.ttl }}
    loop_wait: {{ patroni_bootstrap_dcs.loop_wait }}
    retry_timeout: {{ patroni_bootstrap_dcs.retry_timeout }}
    maximum_lag_on_failover: {{ patroni_bootstrap_dcs.maximum_lag_on_failover }}
    postgresql:
      use_pg_rewind: {{ patroni_bootstrap_dcs.postgresql.use_pg_rewind | lower }}
      use_slots: {{ patroni_bootstrap_dcs.postgresql.use_slots | lower }}
      parameters:
{% for key, value in patroni_postgresql_parameters.items() %}
        {{ key }}: {{ value }}
{% endfor %}

  initdb:
    - encoding: UTF8
    - data-checksums

  pg_hba:
    - host replication {{ patroni_replication_username }} 0.0.0.0/0 scram-sha-256
    - host all all 0.0.0.0/0 scram-sha-256

  users:
    {{ patroni_superuser_username }}:
      password: {{ patroni_superuser_password }}
      options:
        - createrole
        - createdb
    {{ patroni_replication_username }}:
      password: {{ patroni_replication_password }}
      options:
        - replication

postgresql:
  listen: {{ patroni_postgresql_listen }}:{{ patroni_postgresql_port }}
  connect_address: {{ ansible_host }}:{{ patroni_postgresql_port }}
  data_dir: {{ patroni_postgresql_data_dir }}
  bin_dir: {{ patroni_postgresql_bin_dir }}
  pgpass: /tmp/pgpass
  authentication:
    superuser:
      username: {{ patroni_superuser_username }}
      password: {{ patroni_superuser_password }}
    replication:
      username: {{ patroni_replication_username }}
      password: {{ patroni_replication_password }}
  parameters:
{% for key, value in patroni_postgresql_parameters.items() %}
    {{ key }}: {{ value }}
{% endfor %}
  pg_hba:
    - local all all trust
    - host replication {{ patroni_replication_username }} 0.0.0.0/0 scram-sha-256
    - host all all 0.0.0.0/0 scram-sha-256

{% if patroni_watchdog_mode != "off" %}
watchdog:
  mode: {{ patroni_watchdog_mode }}
  device: {{ patroni_watchdog_device }}
  safety_margin: 5
{% endif %}

tags:
  nofailover: {{ patroni_tags.nofailover | lower }}
  noloadbalance: {{ patroni_tags.noloadbalance | lower }}
  clonefrom: {{ patroni_tags.clonefrom | lower }}
  nosync: {{ patroni_tags.nosync | lower }}
