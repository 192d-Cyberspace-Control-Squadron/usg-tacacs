#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-only
# Health check script for TACACS+ server
# Managed by Ansible - do not edit manually

set -e

HEALTH_URL="{{ tacacs_ha_health_url }}"
TIMEOUT={{ tacacs_ha_health_timeout }}

# Check if tacacs-server process is running
if ! pgrep -x tacacs-server > /dev/null 2>&1; then
    echo "tacacs-server process not running"
    exit 1
fi

# Check HTTP health endpoint
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout "${TIMEOUT}" "${HEALTH_URL}" 2>/dev/null || echo "000")

if [ "${HTTP_CODE}" = "200" ]; then
    exit 0
else
    echo "Health check failed: HTTP ${HTTP_CODE}"
    exit 1
fi
