# SPDX-License-Identifier: Apache-2.0
# HAProxy configuration for TACACS+ high availability
# Managed by Ansible - do not edit manually

global
    log /dev/log {{ tacacs_ha_log_facility }} {{ tacacs_ha_log_level }}
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user {{ tacacs_ha_haproxy_user }}
    group {{ tacacs_ha_haproxy_group }}
    daemon
    maxconn {{ tacacs_ha_maxconn_global }}

    # Security hardening
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    tcp
    option  {{ tacacs_ha_log_format }}
    option  dontlognull
    option  redispatch
    retries 3
    timeout connect {{ tacacs_ha_timeout_connect }}
    timeout client  {{ tacacs_ha_timeout_client }}
    timeout server  {{ tacacs_ha_timeout_server }}
    timeout check   {{ tacacs_ha_timeout_check }}
    maxconn {{ tacacs_ha_maxconn_frontend }}

# =============================================================================
# Stats Interface
# =============================================================================
{% if tacacs_ha_stats_enabled | bool %}
frontend stats
    bind {{ tacacs_ha_bind_address }}:{{ tacacs_ha_stats_port }}
    mode http
    option httplog
    stats enable
    stats uri {{ tacacs_ha_stats_uri }}
    stats refresh {{ tacacs_ha_stats_refresh }}
    stats auth {{ tacacs_ha_stats_user }}:{{ tacacs_ha_stats_password }}
    stats admin if TRUE
    stats show-legends
    stats show-node
    # Health check endpoint for the HAProxy itself
    monitor-uri /health
{% endif %}

# =============================================================================
# TACACS+ Legacy Port (49)
# =============================================================================
frontend tacacs_legacy
    bind {{ tacacs_ha_bind_address }}:{{ tacacs_ha_legacy_port }}
    mode tcp
    option tcplog
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"
    maxconn {{ tacacs_ha_maxconn_frontend }}
    default_backend tacacs_backend_legacy

backend tacacs_backend_legacy
    mode tcp
    balance {{ tacacs_ha_balance_algorithm }}
{% if tacacs_ha_stick_table_enabled | bool %}
    stick-table type ip size {{ tacacs_ha_stick_table_size }} expire {{ tacacs_ha_stick_table_expire }}
    stick on src
{% endif %}
{% if tacacs_ha_health_check_enabled | bool %}
    option httpchk GET {{ tacacs_ha_health_check_uri }}
    http-check expect status 200
{% endif %}
{% for backend in tacacs_ha_backends %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.port | default(49) }} check port {{ backend.http_port | default(tacacs_ha_health_check_port) }} inter {{ tacacs_ha_health_check_interval }} rise {{ tacacs_ha_health_check_rise }} fall {{ tacacs_ha_health_check_fall }} weight {{ backend.weight | default(100) }} maxconn {{ tacacs_ha_maxconn_server }}{% if backend.backup | default(false) %} backup{% endif %}

{% endfor %}

# =============================================================================
# TACACS+ TLS Port (300)
# =============================================================================
frontend tacacs_tls
    bind {{ tacacs_ha_bind_address }}:{{ tacacs_ha_tls_port }}
    mode tcp
    option tcplog
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"
    maxconn {{ tacacs_ha_maxconn_frontend }}
    default_backend tacacs_backend_tls

backend tacacs_backend_tls
    mode tcp
    balance {{ tacacs_ha_balance_algorithm }}
{% if tacacs_ha_stick_table_enabled | bool %}
    stick-table type ip size {{ tacacs_ha_stick_table_size }} expire {{ tacacs_ha_stick_table_expire }}
    stick on src
{% endif %}
{% if tacacs_ha_health_check_enabled | bool %}
    option httpchk GET {{ tacacs_ha_health_check_uri }}
    http-check expect status 200
{% endif %}
{% for backend in tacacs_ha_backends %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.tls_port | default(300) }} check port {{ backend.http_port | default(tacacs_ha_health_check_port) }} inter {{ tacacs_ha_health_check_interval }} rise {{ tacacs_ha_health_check_rise }} fall {{ tacacs_ha_health_check_fall }} weight {{ backend.weight | default(100) }} maxconn {{ tacacs_ha_maxconn_server }}{% if backend.backup | default(false) %} backup{% endif %}

{% endfor %}

# =============================================================================
# HTTP API Proxy (for aggregated metrics/health)
# =============================================================================
frontend http_api
    bind {{ tacacs_ha_bind_address }}:{{ tacacs_ha_http_port }}
    mode http
    option httplog
    maxconn {{ tacacs_ha_maxconn_frontend }}

    # Route based on path
    acl is_metrics path_beg /metrics
    acl is_health path_beg /health /ready /live

    use_backend tacacs_backend_http_metrics if is_metrics
    use_backend tacacs_backend_http_health if is_health
    default_backend tacacs_backend_http

backend tacacs_backend_http
    mode http
    balance {{ tacacs_ha_balance_algorithm }}
    option httpchk GET {{ tacacs_ha_health_check_uri }}
    http-check expect status 200
{% for backend in tacacs_ha_backends %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.http_port | default(8080) }} check inter {{ tacacs_ha_health_check_interval }} rise {{ tacacs_ha_health_check_rise }} fall {{ tacacs_ha_health_check_fall }} weight {{ backend.weight | default(100) }}{% if backend.backup | default(false) %} backup{% endif %}

{% endfor %}

backend tacacs_backend_http_metrics
    mode http
    balance roundrobin
    # Aggregate metrics from all healthy backends
    option httpchk GET {{ tacacs_ha_health_check_uri }}
    http-check expect status 200
{% for backend in tacacs_ha_backends %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.http_port | default(8080) }} check inter {{ tacacs_ha_health_check_interval }} rise {{ tacacs_ha_health_check_rise }} fall {{ tacacs_ha_health_check_fall }}
{% endfor %}

backend tacacs_backend_http_health
    mode http
    balance roundrobin
    option httpchk GET {{ tacacs_ha_health_check_uri }}
    http-check expect status 200
{% for backend in tacacs_ha_backends %}
    server {{ backend.name }} {{ backend.address }}:{{ backend.http_port | default(8080) }} check inter {{ tacacs_ha_health_check_interval }} rise {{ tacacs_ha_health_check_rise }} fall {{ tacacs_ha_health_check_fall }}
{% endfor %}
