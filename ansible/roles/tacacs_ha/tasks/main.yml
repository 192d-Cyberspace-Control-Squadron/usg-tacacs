# SPDX-License-Identifier: Apache-2.0
# tacacs_ha - Main tasks for HAProxy-based HA configuration
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - tacacs_ha_backends | length > 0
      - tacacs_ha_stats_password != "CHANGE_ME"
    fail_msg: "Required variables not set: tacacs_ha_backends must have at least one entry and tacacs_ha_stats_password must be changed"

- name: Install HAProxy
  ansible.builtin.package:
    name: haproxy
    state: present

- name: Create HAProxy configuration directory
  ansible.builtin.file:
    path: /etc/haproxy
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create HAProxy errors directory
  ansible.builtin.file:
    path: /etc/haproxy/errors
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy HAProxy error pages
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/haproxy/errors/{{ item | basename }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - 400.http
    - 403.http
    - 408.http
    - 500.http
    - 502.http
    - 503.http
    - 504.http
  ignore_errors: true

- name: Deploy HAProxy configuration
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    owner: root
    group: root
    mode: "0644"
    validate: haproxy -c -f %s
  notify: Reload haproxy

- name: Create HAProxy systemd override directory
  ansible.builtin.file:
    path: /etc/systemd/system/haproxy.service.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy HAProxy systemd override
  ansible.builtin.template:
    src: haproxy-override.conf.j2
    dest: /etc/systemd/system/haproxy.service.d/override.conf
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart haproxy

- name: Create HAProxy runtime directory
  ansible.builtin.file:
    path: /run/haproxy
    state: directory
    owner: "{{ tacacs_ha_haproxy_user }}"
    group: "{{ tacacs_ha_haproxy_group }}"
    mode: "0755"

- name: Enable and start HAProxy
  ansible.builtin.systemd:
    name: haproxy
    enabled: true
    state: started
    daemon_reload: true

- name: Configure firewall for TACACS+ ports (firewalld)
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - "{{ tacacs_ha_legacy_port }}"
    - "{{ tacacs_ha_tls_port }}"
    - "{{ tacacs_ha_http_port }}"
    - "{{ tacacs_ha_stats_port }}"
  when:
    - tacacs_ha_configure_firewall | bool
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: Configure firewall for TACACS+ ports (ufw)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "{{ tacacs_ha_legacy_port }}"
    - "{{ tacacs_ha_tls_port }}"
    - "{{ tacacs_ha_http_port }}"
    - "{{ tacacs_ha_stats_port }}"
  when:
    - tacacs_ha_configure_firewall | bool
    - ansible_os_family == "Debian"
  ignore_errors: true

- name: Wait for HAProxy to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ tacacs_ha_stats_port }}/health"
    status_code: 200
  register: haproxy_health
  retries: 5
  delay: 2
  until: haproxy_health.status == 200
  when: tacacs_ha_stats_enabled | bool
