# SPDX-License-Identifier: AGPL-3.0-only
# etcd configuration for Patroni DCS
# Managed by Ansible - do not edit manually

# Member configuration
name: {{ inventory_hostname }}
data-dir: {{ etcd_data_dir }}
{% if etcd_wal_dir %}
wal-dir: {{ etcd_wal_dir }}
{% endif %}

# Cluster configuration
initial-cluster-state: new
initial-cluster-token: {{ etcd_cluster_name }}
initial-cluster: {% for member in etcd_cluster_members %}{{ member.name }}=http://{{ member.host }}:{{ etcd_peer_port }}{% if not loop.last %},{% endif %}{% endfor %}

initial-advertise-peer-urls: http://{{ ansible_host }}:{{ etcd_peer_port }}
listen-peer-urls: {{ etcd_listen_peer_urls }}
advertise-client-urls: http://{{ ansible_host }}:{{ etcd_client_port }}
listen-client-urls: {{ etcd_listen_client_urls }}

# Tuning
heartbeat-interval: {{ etcd_heartbeat_interval }}
election-timeout: {{ etcd_election_timeout }}
snapshot-count: {{ etcd_snapshot_count }}
max-snapshots: {{ etcd_max_snapshots }}
max-wals: {{ etcd_max_wals }}
quota-backend-bytes: {{ etcd_quota_backend_bytes }}
max-request-bytes: {{ etcd_max_request_bytes }}

# Logging
log-level: {{ etcd_log_level }}
logger: zap
log-outputs:
  - stderr

{% if etcd_tls_enabled %}
# Client TLS
client-transport-security:
  cert-file: {{ etcd_tls_cert_file }}
  key-file: {{ etcd_tls_key_file }}
  client-cert-auth: true
  trusted-ca-file: {{ etcd_tls_ca_file }}
{% endif %}

{% if etcd_peer_tls_enabled %}
# Peer TLS
peer-transport-security:
  cert-file: {{ etcd_peer_tls_cert_file }}
  key-file: {{ etcd_peer_tls_key_file }}
  client-cert-auth: true
  trusted-ca-file: {{ etcd_peer_tls_ca_file }}
{% endif %}

# Auto compaction
auto-compaction-mode: periodic
auto-compaction-retention: "1h"
