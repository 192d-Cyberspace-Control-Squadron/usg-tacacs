# SPDX-License-Identifier: AGPL-3.0-only
# etcd - Main tasks for etcd cluster deployment
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - etcd_cluster_members | length >= 3
      - etcd_cluster_name | length > 0
    fail_msg: "etcd requires at least 3 cluster members and a cluster name"

- name: Create etcd group
  ansible.builtin.group:
    name: "{{ etcd_group }}"
    system: true
    state: present

- name: Create etcd user
  ansible.builtin.user:
    name: "{{ etcd_user }}"
    group: "{{ etcd_group }}"
    system: true
    shell: /sbin/nologin
    home: "{{ etcd_data_dir }}"
    create_home: false

- name: Create etcd directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ etcd_user }}"
    group: "{{ etcd_group }}"
    mode: "0750"
  loop:
    - "{{ etcd_data_dir }}"
    - /etc/etcd

- name: Download etcd binary
  ansible.builtin.unarchive:
    src: "https://github.com/etcd-io/etcd/releases/download/v{{ etcd_version }}/etcd-v{{ etcd_version }}-linux-amd64.tar.gz"
    dest: /tmp
    remote_src: true
    creates: "/tmp/etcd-v{{ etcd_version }}-linux-amd64"

- name: Install etcd binaries
  ansible.builtin.copy:
    src: "/tmp/etcd-v{{ etcd_version }}-linux-amd64/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: "0755"
    remote_src: true
  loop:
    - etcd
    - etcdctl
    - etcdutl

- name: Deploy etcd configuration
  ansible.builtin.template:
    src: etcd.conf.yml.j2
    dest: /etc/etcd/etcd.conf.yml
    owner: "{{ etcd_user }}"
    group: "{{ etcd_group }}"
    mode: "0640"
  notify: Restart etcd

- name: Deploy etcd systemd service
  ansible.builtin.template:
    src: etcd.service.j2
    dest: /etc/systemd/system/etcd.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart etcd

- name: Configure firewall for etcd (firewalld)
  ansible.posix.firewalld:
    port: "{{ item }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - "{{ etcd_client_port }}"
    - "{{ etcd_peer_port }}"
  when:
    - etcd_configure_firewall | bool
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: Configure firewall for etcd (ufw)
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "{{ etcd_client_port }}"
    - "{{ etcd_peer_port }}"
  when:
    - etcd_configure_firewall | bool
    - ansible_os_family == "Debian"
  ignore_errors: true

- name: Enable and start etcd
  ansible.builtin.systemd:
    name: etcd
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for etcd to be healthy
  ansible.builtin.command:
    cmd: /usr/local/bin/etcdctl endpoint health --endpoints=http://127.0.0.1:{{ etcd_client_port }}
  register: etcd_health
  retries: 10
  delay: 3
  until: etcd_health.rc == 0
  changed_when: false
