# SPDX-License-Identifier: Apache-2.0
# frr_anycast - Main tasks for BGP anycast with FRR
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - frr_anycast_vip | length > 0
      - frr_bgp_asn > 0
      - frr_bgp_neighbors | length > 0
    fail_msg: "Required variables not set: frr_anycast_vip, frr_bgp_asn, and frr_bgp_neighbors"

- name: Install FRR repository (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - name: Add FRR GPG key
      ansible.builtin.apt_key:
        url: https://deb.frrouting.org/frr/keys.gpg
        state: present

    - name: Add FRR repository
      ansible.builtin.apt_repository:
        repo: "deb https://deb.frrouting.org/frr {{ ansible_distribution_release }} frr-stable"
        state: present

- name: Install FRR repository (RHEL)
  when: ansible_os_family == "RedHat"
  block:
    - name: Add FRR repository
      ansible.builtin.yum_repository:
        name: frr
        description: FRR stable repository
        baseurl: "https://rpm.frrouting.org/repo/el{{ ansible_distribution_major_version }}/$basearch"
        gpgcheck: false
        enabled: true

- name: Install FRR
  ansible.builtin.package:
    name: frr
    state: present

- name: Install FRR Python tools
  ansible.builtin.package:
    name: frr-pythontools
    state: present
  ignore_errors: true

- name: Create FRR directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ frr_user }}"
    group: "{{ frr_group }}"
    mode: "0750"
  loop:
    - "{{ frr_conf_dir }}"
    - /var/log/frr

- name: Deploy FRR daemons configuration
  ansible.builtin.template:
    src: daemons.j2
    dest: "{{ frr_conf_dir }}/daemons"
    owner: "{{ frr_user }}"
    group: "{{ frr_group }}"
    mode: "0640"
  notify: Restart frr

- name: Deploy FRR main configuration
  ansible.builtin.template:
    src: frr.conf.j2
    dest: "{{ frr_conf_dir }}/frr.conf"
    owner: "{{ frr_user }}"
    group: "{{ frr_group }}"
    mode: "0640"
  notify: Reload frr

- name: Deploy health check script
  ansible.builtin.template:
    src: tacacs-health-check.sh.j2
    dest: /usr/local/bin/tacacs-health-check.sh
    owner: root
    group: root
    mode: "0755"

- name: Deploy health check systemd service
  ansible.builtin.template:
    src: tacacs-anycast-health.service.j2
    dest: /etc/systemd/system/tacacs-anycast-health.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart tacacs-anycast-health

- name: Configure anycast VIP on loopback
  ansible.builtin.template:
    src: anycast-vip.conf.j2
    dest: /etc/network/interfaces.d/anycast-vip.conf
    owner: root
    group: root
    mode: "0644"
  when: ansible_os_family == "Debian"
  notify: Configure anycast interface

- name: Configure anycast VIP on loopback (RHEL)
  ansible.builtin.template:
    src: ifcfg-lo1.j2
    dest: /etc/sysconfig/network-scripts/ifcfg-lo:1
    owner: root
    group: root
    mode: "0644"
  when: ansible_os_family == "RedHat"
  notify: Configure anycast interface rhel

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: "net.ipv4.ip_forward", value: "1" }
    - { name: "net.ipv4.conf.all.arp_ignore", value: "1" }
    - { name: "net.ipv4.conf.all.arp_announce", value: "2" }

- name: Configure firewall for BGP (firewalld)
  ansible.posix.firewalld:
    port: 179/tcp
    permanent: true
    state: enabled
    immediate: true
  when:
    - frr_configure_firewall | bool
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: Configure firewall for BGP (ufw)
  community.general.ufw:
    rule: allow
    port: "179"
    proto: tcp
  when:
    - frr_configure_firewall | bool
    - ansible_os_family == "Debian"
  ignore_errors: true

- name: Enable and start FRR
  ansible.builtin.systemd:
    name: frr
    enabled: true
    state: started
    daemon_reload: true

- name: Enable and start anycast health check
  ansible.builtin.systemd:
    name: tacacs-anycast-health
    enabled: true
    state: started
    daemon_reload: true
  when: frr_health_check_enabled | bool

- name: Wait for BGP to establish
  ansible.builtin.command:
    cmd: vtysh -c "show bgp summary"
  register: bgp_summary
  retries: 10
  delay: 5
  until: bgp_summary.rc == 0
  changed_when: false
  ignore_errors: true

- name: Display BGP status
  ansible.builtin.debug:
    msg: "{{ bgp_summary.stdout_lines }}"
  when: bgp_summary.rc == 0
