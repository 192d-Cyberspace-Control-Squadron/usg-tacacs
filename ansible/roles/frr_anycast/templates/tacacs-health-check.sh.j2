#!/bin/bash
# SPDX-License-Identifier: AGPL-3.0-only
# TACACS+ Anycast Health Check Script
# Manages BGP route advertisement based on TACACS+ service health
# Managed by Ansible - do not edit manually

set -euo pipefail

# Configuration
HEALTH_URL="{{ frr_health_check_url }}"
CHECK_INTERVAL={{ frr_health_check_interval }}
CHECK_TIMEOUT={{ frr_health_check_timeout }}
FAILURE_THRESHOLD={{ frr_health_check_failures }}
ANYCAST_VIP="{{ frr_anycast_vip }}"
ANYCAST_PREFIX="{{ frr_anycast_vip_prefix }}"
ROUTE_MAP_HEALTHY="{{ frr_route_map_name }}"
ROUTE_MAP_DRAIN="{{ frr_route_map_name }}-DRAIN"
LOG_TAG="tacacs-anycast-health"

# State tracking
FAILURE_COUNT=0
CURRENT_STATE="unknown"
DRAINING=false

# Logging helper
log() {
    logger -t "${LOG_TAG}" -p "daemon.$1" "$2"
    echo "$(date -Iseconds) [$1] $2"
}

# Check TACACS+ health
check_health() {
    local http_code
    http_code=$(curl -s -o /dev/null -w "%{http_code}" \
        --connect-timeout "${CHECK_TIMEOUT}" \
        --max-time "${CHECK_TIMEOUT}" \
        "${HEALTH_URL}" 2>/dev/null || echo "000")

    if [[ "${http_code}" == "200" ]]; then
        return 0
    elif [[ "${http_code}" == "503" ]]; then
        # 503 means draining/shutting down
        DRAINING=true
        return 1
    else
        DRAINING=false
        return 1
    fi
}

# Advertise route (healthy)
advertise_route() {
    if [[ "${CURRENT_STATE}" == "advertised" ]]; then
        return 0
    fi

    log "info" "Advertising anycast route ${ANYCAST_VIP}/${ANYCAST_PREFIX}"

    # Use vtysh to update route-map
    vtysh -c "configure terminal" \
          -c "router bgp {{ frr_bgp_asn }}" \
          -c "address-family ipv4 unicast" \
          -c "redistribute connected route-map ${ROUTE_MAP_HEALTHY}" \
          -c "end" \
          -c "write memory" 2>/dev/null || {
        log "error" "Failed to advertise route via vtysh"
        return 1
    }

    CURRENT_STATE="advertised"
    log "info" "Route advertised successfully"
}

# Withdraw route (unhealthy)
withdraw_route() {
    if [[ "${CURRENT_STATE}" == "withdrawn" ]]; then
        return 0
    fi

    log "warning" "Withdrawing anycast route ${ANYCAST_VIP}/${ANYCAST_PREFIX}"

    # Remove redistribution to withdraw the route
    vtysh -c "configure terminal" \
          -c "router bgp {{ frr_bgp_asn }}" \
          -c "address-family ipv4 unicast" \
          -c "no redistribute connected" \
          -c "end" \
          -c "write memory" 2>/dev/null || {
        log "error" "Failed to withdraw route via vtysh"
        return 1
    }

    CURRENT_STATE="withdrawn"
    log "warning" "Route withdrawn successfully"
}

# Set draining state (lower preference)
set_draining() {
    if [[ "${CURRENT_STATE}" == "draining" ]]; then
        return 0
    fi

    log "info" "Setting route to draining state (lower preference)"

    # Use draining route-map with lower local-preference
    vtysh -c "configure terminal" \
          -c "router bgp {{ frr_bgp_asn }}" \
          -c "address-family ipv4 unicast" \
          -c "redistribute connected route-map ${ROUTE_MAP_DRAIN}" \
          -c "end" \
          -c "write memory" 2>/dev/null || {
        log "error" "Failed to set draining state via vtysh"
        return 1
    }

    CURRENT_STATE="draining"
    log "info" "Route set to draining state"
}

# Signal handlers
handle_sigterm() {
    log "info" "Received SIGTERM, withdrawing route and exiting"
    withdraw_route
    exit 0
}

handle_sighup() {
    log "info" "Received SIGHUP, re-checking health immediately"
    FAILURE_COUNT=0
}

trap handle_sigterm SIGTERM SIGINT
trap handle_sighup SIGHUP

# Main loop
log "info" "Starting TACACS+ anycast health monitor"
log "info" "Health URL: ${HEALTH_URL}"
log "info" "Check interval: ${CHECK_INTERVAL}s, Failure threshold: ${FAILURE_THRESHOLD}"

# Initial check
if check_health; then
    advertise_route
else
    log "warning" "Initial health check failed, route not advertised"
fi

while true; do
    sleep "${CHECK_INTERVAL}"

    if check_health; then
        FAILURE_COUNT=0
        if [[ "${CURRENT_STATE}" != "advertised" ]]; then
            advertise_route
        fi
    else
        ((FAILURE_COUNT++)) || true

        if [[ "${DRAINING}" == "true" ]]; then
            # Service is draining, use lower preference
            set_draining
        elif [[ ${FAILURE_COUNT} -ge ${FAILURE_THRESHOLD} ]]; then
            # Too many failures, withdraw route
            withdraw_route
        else
            log "warning" "Health check failed (${FAILURE_COUNT}/${FAILURE_THRESHOLD})"
        fi
    fi
done
