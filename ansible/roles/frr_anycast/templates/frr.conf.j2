! SPDX-License-Identifier: AGPL-3.0-only
! FRR configuration for TACACS+ BGP Anycast
! Managed by Ansible - do not edit manually
!
frr version 8.5
frr defaults traditional
hostname {{ inventory_hostname }}
log file {{ frr_log_file }} {{ frr_log_level }}
log syslog {{ frr_log_level }}
service integrated-vtysh-config
!
! ============================================================================
! Interface configuration
! ============================================================================
!
interface lo
 description Loopback interface
!
interface {{ frr_anycast_loopback }}
 description TACACS+ Anycast VIP
 ip address {{ frr_anycast_vip }}/{{ frr_anycast_vip_prefix }}
!
! ============================================================================
! Prefix list for anycast VIP
! ============================================================================
!
ip prefix-list {{ frr_prefix_list_name }} seq 10 permit {{ frr_anycast_vip }}/{{ frr_anycast_vip_prefix }}
!
! ============================================================================
! Route-map for anycast advertisement
! ============================================================================
!
route-map {{ frr_route_map_name }} permit 10
 match ip address prefix-list {{ frr_prefix_list_name }}
 set community {{ frr_bgp_community_healthy }}{% if frr_bgp_community_location %} {{ frr_bgp_community_location }}{% endif %}

!
route-map {{ frr_route_map_name }}-DRAIN permit 10
 match ip address prefix-list {{ frr_prefix_list_name }}
 set community {{ frr_bgp_community_draining }}{% if frr_bgp_community_location %} {{ frr_bgp_community_location }}{% endif %}

 set local-preference 50
!
! ============================================================================
! BGP configuration
! ============================================================================
!
router bgp {{ frr_bgp_asn }}
 bgp router-id {{ frr_bgp_router_id }}
 bgp log-neighbor-changes
 bgp graceful-restart
 bgp graceful-restart preserve-fw-state
 no bgp default ipv4-unicast
 !
 ! Timers
 timers bgp {{ frr_bgp_keepalive }} {{ frr_bgp_holdtime }}
 !
 ! Neighbors
{% for neighbor in frr_bgp_neighbors %}
 neighbor {{ neighbor.address }} remote-as {{ neighbor.remote_asn }}
{% if neighbor.description is defined %}
 neighbor {{ neighbor.address }} description {{ neighbor.description }}
{% endif %}
{% if neighbor.password is defined and neighbor.password %}
 neighbor {{ neighbor.address }} password {{ neighbor.password }}
{% endif %}
 neighbor {{ neighbor.address }} timers connect {{ frr_bgp_connect_retry }}
{% if frr_bfd_enabled %}
 neighbor {{ neighbor.address }} bfd
{% endif %}
{% endfor %}
 !
 address-family ipv4 unicast
{% for neighbor in frr_bgp_neighbors %}
  neighbor {{ neighbor.address }} activate
  neighbor {{ neighbor.address }} soft-reconfiguration inbound
  neighbor {{ neighbor.address }} route-map {{ frr_route_map_name }} out
{% endfor %}
  !
  ! Redistribute connected routes (anycast VIP)
  redistribute connected route-map {{ frr_route_map_name }}
 exit-address-family
!
{% if frr_bfd_enabled %}
! ============================================================================
! BFD configuration for fast failover
! ============================================================================
!
bfd
{% for neighbor in frr_bgp_neighbors %}
 peer {{ neighbor.address }}
  receive-interval {{ frr_bfd_min_rx }}
  transmit-interval {{ frr_bfd_min_tx }}
  detect-multiplier {{ frr_bfd_detect_multiplier }}
 !
{% endfor %}
!
{% endif %}
!
line vty
!
