# SPDX-License-Identifier: Apache-2.0
# pgbouncer - Main tasks for PgBouncer connection pooler
---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - pgbouncer_databases | length > 0
      - pgbouncer_users | length > 0
    fail_msg: "pgbouncer_databases and pgbouncer_users are required"

- name: Install PgBouncer
  ansible.builtin.package:
    name: pgbouncer
    state: present

- name: Create pgbouncer group
  ansible.builtin.group:
    name: "{{ pgbouncer_group }}"
    system: true
    state: present

- name: Create pgbouncer user
  ansible.builtin.user:
    name: "{{ pgbouncer_user }}"
    group: "{{ pgbouncer_group }}"
    system: true
    shell: /sbin/nologin
    home: "{{ pgbouncer_conf_dir }}"
    create_home: false

- name: Create PgBouncer directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ pgbouncer_user }}"
    group: "{{ pgbouncer_group }}"
    mode: "0750"
  loop:
    - "{{ pgbouncer_conf_dir }}"
    - "{{ pgbouncer_log_dir }}"
    - "{{ pgbouncer_run_dir }}"

- name: Deploy PgBouncer configuration
  ansible.builtin.template:
    src: pgbouncer.ini.j2
    dest: "{{ pgbouncer_conf_dir }}/pgbouncer.ini"
    owner: "{{ pgbouncer_user }}"
    group: "{{ pgbouncer_group }}"
    mode: "0640"
  notify: Reload pgbouncer

- name: Deploy PgBouncer userlist
  ansible.builtin.template:
    src: userlist.txt.j2
    dest: "{{ pgbouncer_auth_file }}"
    owner: "{{ pgbouncer_user }}"
    group: "{{ pgbouncer_group }}"
    mode: "0600"
  notify: Reload pgbouncer

- name: Deploy PgBouncer systemd service
  ansible.builtin.template:
    src: pgbouncer.service.j2
    dest: /etc/systemd/system/pgbouncer.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart pgbouncer

- name: Configure firewall for PgBouncer (firewalld)
  ansible.posix.firewalld:
    port: "{{ pgbouncer_listen_port }}/tcp"
    permanent: true
    state: enabled
    immediate: true
  when:
    - pgbouncer_configure_firewall | bool
    - ansible_os_family == "RedHat"
  ignore_errors: true

- name: Configure firewall for PgBouncer (ufw)
  community.general.ufw:
    rule: allow
    port: "{{ pgbouncer_listen_port }}"
    proto: tcp
  when:
    - pgbouncer_configure_firewall | bool
    - ansible_os_family == "Debian"
  ignore_errors: true

- name: Enable and start PgBouncer
  ansible.builtin.systemd:
    name: pgbouncer
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for PgBouncer to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ pgbouncer_listen_port }}"
    timeout: 30
